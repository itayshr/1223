<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מערכת ניהול לימודים מתקדמת</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #4CAF50;
      --background-color: #f0f8ff;
      --error-color: #d32f2f;
      --success-color: #388e3c;
      --dark-bg: #1e1e1e;
      --dark-text: #f5f5f5;
    }
    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial', sans-serif;
      /* Direction will be updated dynamically */
      direction: rtl;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--primary-color);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s, font-family 0.3s;
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    /* Responsive design */
    @media (max-width: 600px) {
      input, select {
        width: 90%;
      }
      .auth-container, .day-container {
        margin: 1rem auto;
      }
    }
    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .dashboard {
      display: none;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }
    #clock {
      font-size: 1.2em;
      font-weight: bold;
    }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: var(--secondary-color);
      color: white;
      transition: all 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    button:focus {
      outline: 2px solid var(--secondary-color);
    }
    input, select {
      margin: 10px;
      padding: 12px;
      width: 300px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: var(--secondary-color);
      outline: none;
    }
    .day-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }
    .day-container:hover {
      transform: scale(1.02);
    }
    .subject-card {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      background: #e8f5e9;
      padding: 8px 15px;
      margin: 5px;
      border-radius: 20px;
      cursor: grab;
      transition: all 0.2s ease;
    }
    .subject-card:hover {
      background: #c8e6c9;
      transform: scale(1.05);
    }
    .subject-card.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .remove-btn {
      cursor: pointer;
      margin-left: 10px;
      font-weight: bold;
      color: var(--error-color);
    }
    .calendar-view {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .calendar-view div {
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .modal, .settings-modal, .profile-modal, .help-modal {
      display: none;
      position: fixed;
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1100;
      max-width: 300px;
    }
    .modal, .profile-modal, .help-modal {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .settings-modal {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1001;
    }
    .error { background: #ffebee; color: var(--error-color); }
    .success { background: #e8f5e9; color: var(--success-color); }
    .dark-mode .day-container {
      background: #333;
      color: var(--dark-text);
    }
    .dark-mode .subject-card {
      background: #444;
      color: var(--dark-text);
    }
    .dark-mode .modal,
    .dark-mode .settings-modal,
    .dark-mode .profile-modal,
    .dark-mode .help-modal {
      background: #333;
      color: var(--dark-text);
    }
    /* Weather and bag items sections */
    .weather-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .bag-items {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    /* Progress bar */
    #progress-container {
      width: 100%;
      background: #ddd;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    #progress-bar {
      height: 20px;
      background: var(--secondary-color);
      width: 0%;
      transition: width 0.5s;
    }
  </style>
</head>
<body>
  <!-- Authentication Container -->
  <div class="auth-container" id="auth-container">
    <h1 id="auth-heading">🎓 מערכת ניהול לימודים מתקדמת</h1>
    <div id="login-or-register">
      <button id="btn-new-registration" title="Register" onclick="showAuthForm('register')">📝 הרשמה חדשה</button>
      <button id="btn-login" title="Login" onclick="showAuthForm('login')">🔑 התחברות</button>
    </div>
    <div id="register-form" style="display: none;">
      <h2 id="register-heading">הרשמה</h2>
      <input type="text" id="reg-username" placeholder="שם משתמש" aria-label="Username">
      <input type="password" id="reg-password" placeholder="סיסמה" aria-label="Password">
      <input type="password" id="reg-confirm-password" placeholder="אימות סיסמה" aria-label="Confirm Password">
      <button onclick="register()">הרשמה</button>
    </div>
    <div id="login-form" style="display: none;">
      <h2 id="login-heading">התחברות</h2>
      <input type="text" id="login-username" placeholder="שם משתמש" aria-label="Username">
      <input type="password" id="login-password" placeholder="סיסמה" aria-label="Password">
      <button onclick="login()">התחבר</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <header>
      <div>
        <h1 id="dashboard-greeting">שלום, <span id="current-user"></span>!</h1>
        <div id="clock"></div>
      </div>
      <div>
        <button id="btn-logout" title="Logout" onclick="logout()">🚪 יציאה</button>
        <button id="btn-dark-mode" title="Toggle Dark Mode" onclick="toggleDarkMode()">🌙 מצב לילה</button>
        <select id="language-select" onchange="changeLanguage(this.value)" title="Select Language">
          <option value="he">עברית</option>
          <option value="en">English</option>
          <option value="ru">Русский</option>
          <option value="ar">العربية</option>
          <option value="es">Español</option>
        </select>
        <button id="btn-settings" title="Settings" onclick="toggleSettings()">⚙️ הגדרות</button>
        <button id="btn-profile" title="Edit Profile" onclick="toggleProfile()">👤 פרופיל</button>
        <button id="btn-help" title="Help" onclick="toggleHelp()">❓ עזרה</button>
      </div>
    </header>
    
    <!-- Weather Section -->
    <div class="weather-section">
      <h2 id="weather-heading">⛅ מזג אוויר והמלצות לבוש</h2>
      <select id="city-select" onchange="getWeather(this.value)" title="Select City">
        <option value="">בחר עיר</option>
        <option value="Tel Aviv">תל אביב</option>
        <option value="Jerusalem">ירושלים</option>
        <option value="Haifa">חיפה</option>
        <option value="Beer Sheva">באר שבע</option>
        <option value="Eilat">אילת</option>
      </select>
      <div id="weather-info"></div>
      <div class="bag-items" id="clothing-recommendations"></div>
    </div>

    <!-- Daily Bag Items Section -->
    <div class="weather-section">
      <h2 id="bag-items-heading">🎒 פריטים יומיים לתיק</h2>
      <div id="daily-bag-items"></div>
    </div>

    <!-- Calendar View -->
    <div class="calendar-view" id="calendar"></div>

    <!-- Filter and Search with Progress Bar -->
    <div id="schedule-management">
      <h2 id="schedule-heading">📅 ניהול מערכת שעות</h2>
      <input type="text" id="search-input" placeholder="חפש נושא..." aria-label="Search Subject">
      <select id="category-filter" onchange="filterByCategory(this.value)" title="Filter by Category">
        <option value="all">הכל</option>
        <option value="מתמטיקה">מתמטיקה</option>
        <option value="מדעים">מדעים</option>
        <option value="היסטוריה">היסטוריה</option>
        <option value="כללי">כללי</option>
      </select>
      <!-- Progress Bar -->
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div id="days-container"></div>
    </div>

    <!-- Export and Backup Options -->
    <div class="export-options">
      <button id="btn-export-schedule" title="Export Schedule" onclick="exportSchedule()">📤 ייצוא מערכת שעות</button>
      <button id="btn-export-pdf" title="Export to PDF" onclick="exportToPDF()">📄 ייצוא ל-PDF</button>
      <button id="btn-export-csv" title="Export as CSV" onclick="exportScheduleCSV()">📑 ייצוא כ-CSV</button>
      <button id="btn-import-schedule" title="Import Schedule" onclick="importSchedule()">📥 יבוא מערכת שעות</button>
      <button id="btn-backup-cloud" title="Backup to Cloud" onclick="backupToCloud()">☁️ גיבוי לענן</button>
      <button id="btn-restore-cloud" title="Restore from Cloud" onclick="restoreFromCloud()">♻️ שחזור מגיבוי</button>
      <button id="btn-theme-dark" title="Dark Theme" onclick="setTheme('dark')">נושא כהה</button>
      <button id="btn-theme-light" title="Light Theme" onclick="setTheme('light')">נושא בהיר</button>
      <select id="theme-select" onchange="setCustomTheme(this.value)" title="Custom Theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="red">Red</option>
      </select>
      <button id="btn-print-schedule" title="Print Schedule" onclick="printSchedule()">🖨️ הדפס מערכת שעות</button>
      <button id="btn-speech" title="Voice Input" onclick="startSpeechRecognition()">🎤 הוספת קולי</button>
    </div>
  </div>

  <!-- Modal for Editing Subject -->
  <div class="modal" id="subject-modal">
    <h3>עריכת נושא</h3>
    <input type="text" id="edit-subject-input">
    <input type="text" id="edit-time-input" placeholder="שעה (לדוגמה: 8:00-9:00)">
    <select id="edit-category-input">
      <option value="כללי">כללי</option>
      <option value="מתמטיקה">מתמטיקה</option>
      <option value="מדעים">מדעים</option>
      <option value="היסטוריה">היסטוריה</option>
    </select>
    <button onclick="saveEditedSubject()">שמור שינויים</button>
  </div>
  <div class="overlay" id="modal-overlay"></div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settings-modal">
    <h3>הגדרות מתקדמות</h3>
    <label for="font-select">בחר גופן:</label>
    <select id="font-select" onchange="changeFont(this.value)">
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>
    <button onclick="resetSettings()">אפס הגדרות</button>
    <button onclick="alert('Feature coming soon: Notification Preferences')">העדפות התראות</button>
    <button onclick="alert('Feature coming soon: Auto-Sync Options')">אפשרויות סנכרון אוטומטי</button>
    <button onclick="toggleSettings()">סגור</button>
  </div>

  <!-- Profile Modal -->
  <div class="profile-modal" id="profile-modal">
    <h3>פרופיל משתמש</h3>
    <label for="profile-username">שם משתמש:</label>
    <input type="text" id="profile-username" disabled>
    <label for="profile-password">סיסמה חדשה:</label>
    <input type="password" id="profile-password">
    <button onclick="updateProfile()">עדכן פרופיל</button>
    <button onclick="toggleProfile()">סגור</button>
  </div>

  <!-- Help Modal -->
  <div class="help-modal" id="help-modal">
    <h3>עזרה</h3>
    <p>ברוכים הבאים למערכת ניהול הלימודים. כאן תוכלו:</p>
    <ul>
      <li>להוסיף, לערוך ולסמן נושאים כהושלמו.</li>
      <li>לעקוב אחרי התקדמותכם באמצעות סרגל התקדמות.</li>
      <li>להשתמש בקלט קולי להוספת נושאים.</li>
      <li>לייצא את מערכת השעות כ-JSON, CSV או PDF.</li>
      <li>להתאים אישית את הנושא, הגופן והשפה.</li>
    </ul>
    <button onclick="toggleHelp()">סגור</button>
  </div>

  <script>
    "use strict";
    /***************** Global Variables & Dictionaries *****************/
    const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי'];
    let currentUser = null;
    let currentLang = localStorage.getItem('currentLang') || 'he';
    const translations = {
      en: {
        authHeading: "🎓 Advanced Study Management System",
        newRegistration: "📝 New Registration",
        login: "🔑 Login",
        registerHeading: "Register",
        loginHeading: "Login",
        usernamePlaceholder: "Username",
        passwordPlaceholder: "Password",
        confirmPasswordPlaceholder: "Confirm Password",
        logout: "🚪 Logout",
        darkMode: "🌙 Dark Mode",
        weatherHeading: "⛅ Weather and Clothing Recommendations",
        bagItemsHeading: "🎒 Daily Bag Items",
        scheduleHeading: "📅 Schedule Management",
        addSubject: "Add Subject",
        sortSubjects: "Sort Subjects",
        clearDay: "Clear Day",
        edit: "Edit",
        addNote: "Add Note",
        reminder: "Reminder",
        exportSchedule: "📤 Export Schedule",
        exportToPDF: "📄 Export to PDF",
        importSchedule: "📥 Import Schedule",
        backupToCloud: "☁️ Backup to Cloud",
        restoreFromCloud: "♻️ Restore from Cloud",
        lightMode: "Light Mode",
        themeDark: "Dark Theme",
        language: "Language",
        searchPlaceholder: "Search subject..."
      },
      he: {
        authHeading: "🎓 מערכת ניהול לימודים מתקדמת",
        newRegistration: "📝 הרשמה חדשה",
        login: "🔑 התחברות",
        registerHeading: "הרשמה",
        loginHeading: "התחברות",
        usernamePlaceholder: "שם משתמש",
        passwordPlaceholder: "סיסמה",
        confirmPasswordPlaceholder: "אימות סיסמה",
        logout: "🚪 יציאה",
        darkMode: "🌙 מצב לילה",
        weatherHeading: "⛅ מזג אוויר והמלצות לבוש",
        bagItemsHeading: "🎒 פריטים יומיים לתיק",
        scheduleHeading: "📅 ניהול מערכת שעות",
        addSubject: "הוסף נושא",
        sortSubjects: "מיין נושאים",
        clearDay: "נקה יום",
        edit: "ערוך",
        addNote: "הוסף הערה",
        reminder: "תזכורת",
        exportSchedule: "📤 ייצוא מערכת שעות",
        exportToPDF: "📄 ייצוא ל-PDF",
        importSchedule: "📥 יבוא מערכת שעות",
        backupToCloud: "☁️ גיבוי לענן",
        restoreFromCloud: "♻️ שחזור מגיבוי",
        lightMode: "מצב בהיר",
        themeDark: "נושא כהה",
        language: "שפה",
        searchPlaceholder: "חפש נושא..."
      },
      ru: {
        authHeading: "🎓 Продвинутая система управления обучением",
        newRegistration: "📝 Новая регистрация",
        login: "🔑 Вход",
        registerHeading: "Регистрация",
        loginHeading: "Вход",
        usernamePlaceholder: "Имя пользователя",
        passwordPlaceholder: "Пароль",
        confirmPasswordPlaceholder: "Подтвердите пароль",
        logout: "🚪 Выход",
        darkMode: "🌙 Темный режим",
        weatherHeading: "⛅ Погода и рекомендации по одежде",
        bagItemsHeading: "🎒 Ежедневные вещи в сумке",
        scheduleHeading: "📅 Управление расписанием",
        addSubject: "Добавить предмет",
        sortSubjects: "Сортировать предметы",
        clearDay: "Очистить день",
        edit: "Редактировать",
        addNote: "Добавить заметку",
        reminder: "Напоминание",
        exportSchedule: "📤 Экспорт расписания",
        exportToPDF: "📄 Экспорт в PDF",
        importSchedule: "📥 Импорт расписания",
        backupToCloud: "☁️ Резервное копирование в облако",
        restoreFromCloud: "♻️ Восстановление из облака",
        lightMode: "Светлый режим",
        themeDark: "Темная тема",
        language: "Язык",
        searchPlaceholder: "Поиск предмета..."
      },
      ar: {
        authHeading: "🎓 نظام إدارة دراسات متقدم",
        newRegistration: "📝 تسجيل جديد",
        login: "🔑 تسجيل الدخول",
        registerHeading: "تسجيل",
        loginHeading: "تسجيل الدخول",
        usernamePlaceholder: "اسم المستخدم",
        passwordPlaceholder: "كلمة المرور",
        confirmPasswordPlaceholder: "تأكيد كلمة المرور",
        logout: "🚪 تسجيل الخروج",
        darkMode: "🌙 الوضع الليلي",
        weatherHeading: "⛅ الطقس وتوصيات الملابس",
        bagItemsHeading: "🎒 أغراض الحقيبة اليومية",
        scheduleHeading: "📅 إدارة الجدول",
        addSubject: "أضف مادة",
        sortSubjects: "ترتيب المواد",
        clearDay: "مسح اليوم",
        edit: "تعديل",
        addNote: "أضف ملاحظة",
        reminder: "تذكير",
        exportSchedule: "📤 تصدير الجدول",
        exportToPDF: "📄 تصدير إلى PDF",
        importSchedule: "📥 استيراد الجدول",
        backupToCloud: "☁️ النسخ الاحتياطي إلى السحابة",
        restoreFromCloud: "♻️ استعادة من السحابة",
        lightMode: "الوضع الفاتح",
        themeDark: "السمة الداكنة",
        language: "اللغة",
        searchPlaceholder: "ابحث عن مادة..."
      },
      es: {
        authHeading: "🎓 Sistema Avanzado de Gestión de Estudios",
        newRegistration: "📝 Nueva Registro",
        login: "🔑 Iniciar sesión",
        registerHeading: "Registrarse",
        loginHeading: "Iniciar sesión",
        usernamePlaceholder: "Nombre de usuario",
        passwordPlaceholder: "Contraseña",
        confirmPasswordPlaceholder: "Confirmar contraseña",
        logout: "🚪 Cerrar sesión",
        darkMode: "🌙 Modo oscuro",
        weatherHeading: "⛅ Clima y recomendaciones de vestimenta",
        bagItemsHeading: "🎒 Artículos diarios para la mochila",
        scheduleHeading: "📅 Gestión de horarios",
        addSubject: "Agregar materia",
        sortSubjects: "Ordenar materias",
        clearDay: "Limpiar día",
        edit: "Editar",
        addNote: "Agregar nota",
        reminder: "Recordatorio",
        exportSchedule: "📤 Exportar horario",
        exportToPDF: "📄 Exportar a PDF",
        importSchedule: "📥 Importar horario",
        backupToCloud: "☁️ Respaldo en la nube",
        restoreFromCloud: "♻️ Restaurar desde la nube",
        lightMode: "Modo claro",
        themeDark: "Tema oscuro",
        language: "Idioma",
        searchPlaceholder: "Buscar materia..."
      }
    };

    const themes = {
      light: {
        '--background-color': '#f0f8ff',
        '--primary-color': '#2c3e50',
        '--secondary-color': '#4CAF50'
      },
      dark: {
        '--background-color': '#1e1e1e',
        '--primary-color': '#f5f5f5',
        '--secondary-color': '#4CAF50'
      },
      blue: {
        '--background-color': '#e0f7fa',
        '--primary-color': '#01579b',
        '--secondary-color': '#0288d1'
      },
      green: {
        '--background-color': '#e8f5e9',
        '--primary-color': '#1b5e20',
        '--secondary-color': '#43a047'
      },
      red: {
        '--background-color': '#ffebee',
        '--primary-color': '#b71c1c',
        '--secondary-color': '#e53935'
      }
    };

    /***************** Multi-Language Functions *****************/
    function updateLanguage() {
      localStorage.setItem('currentLang', currentLang);
      if (currentLang === 'he' || currentLang === 'ar') {
        document.body.dir = "rtl";
      } else {
        document.body.dir = "ltr";
      }
      document.getElementById('auth-heading').textContent = translations[currentLang].authHeading;
      document.getElementById('btn-new-registration').textContent = translations[currentLang].newRegistration;
      document.getElementById('btn-login').textContent = translations[currentLang].login;
      document.getElementById('register-heading').textContent = translations[currentLang].registerHeading;
      document.getElementById('login-heading').textContent = translations[currentLang].loginHeading;
      document.getElementById('reg-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('reg-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('reg-confirm-password').placeholder = translations[currentLang].confirmPasswordPlaceholder;
      document.getElementById('login-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('login-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('btn-logout').textContent = translations[currentLang].logout;
      document.getElementById('btn-dark-mode').textContent = translations[currentLang].darkMode;
      document.getElementById('weather-heading').textContent = translations[currentLang].weatherHeading;
      document.getElementById('bag-items-heading').textContent = translations[currentLang].bagItemsHeading;
      document.getElementById('schedule-heading').textContent = translations[currentLang].scheduleHeading;
      document.getElementById('search-input').placeholder = translations[currentLang].searchPlaceholder;
      document.getElementById('btn-export-schedule').textContent = translations[currentLang].exportSchedule;
      document.getElementById('btn-export-pdf').textContent = translations[currentLang].exportToPDF;
      document.getElementById('btn-import-schedule').textContent = translations[currentLang].importSchedule;
      document.getElementById('btn-backup-cloud').textContent = translations[currentLang].backupToCloud;
      document.getElementById('btn-restore-cloud').textContent = translations[currentLang].restoreFromCloud;
      document.getElementById('btn-theme-dark').textContent = translations[currentLang].themeDark;
      document.getElementById('btn-theme-light').textContent = translations[currentLang].lightMode;
      renderScheduleUI();
    }
    function changeLanguage(lang) {
      currentLang = lang;
      updateLanguage();
    }

    /***************** Theme Functions *****************/
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
      } else if (theme === 'light') {
        document.body.classList.remove('dark-mode');
      }
      localStorage.setItem('currentTheme', theme);
    }
    function setCustomTheme(themeName) {
      if(themes[themeName]) {
        Object.keys(themes[themeName]).forEach(key => {
          document.documentElement.style.setProperty(key, themes[themeName][key]);
        });
        localStorage.setItem('currentCustomTheme', themeName);
      }
    }

    /***************** Additional Settings Functions *****************/
    function toggleSettings() {
      const settingsModal = document.getElementById('settings-modal');
      settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
    }
    function resetSettings() {
      localStorage.removeItem('currentLang');
      localStorage.removeItem('currentTheme');
      localStorage.removeItem('currentCustomTheme');
      currentLang = 'he';
      setTheme('light');
      setCustomTheme('light');
      updateLanguage();
      toggleSettings();
      showMessage('ההגדרות אופסו', 'success');
    }
    function changeFont(fontName) {
      document.body.style.fontFamily = fontName;
      localStorage.setItem('currentFont', fontName);
    }

    /***************** Profile Functions *****************/
    function toggleProfile() {
      const profileModal = document.getElementById('profile-modal');
      profileModal.style.display = profileModal.style.display === 'block' ? 'none' : 'block';
      if (currentUser) {
        document.getElementById('profile-username').value = currentUser;
      }
    }
    function updateProfile() {
      // Demo only – in a real app, you'd update the user data
      showMessage('פרופיל עודכן', 'success');
      toggleProfile();
    }

    /***************** Help Functions *****************/
    function toggleHelp() {
      const helpModal = document.getElementById('help-modal');
      helpModal.style.display = helpModal.style.display === 'block' ? 'none' : 'block';
    }

    /***************** Additional Original & New Functions *****************/
    const users = JSON.parse(localStorage.getItem('schoolUsers') || '{}');
    async function getWeather(city) {
      if (!city) return;
      try {
        const response = await fetch(
          `https://api.weatherapi.com/v1/current.json?key=bfba7f78869e4222b89154845251302&q=${city}&aqi=no`
        );
        if (!response.ok) {
          console.error("Weather API error:", response.statusText);
          throw new Error("API error");
        }
        const data = await response.json();
        const weatherInfo = `
          <p>טמפרטורה: ${data.current.temp_c}°C</p>
          <p>תנאים: ${data.current.condition.text}</p>
        `;
        document.getElementById('weather-info').innerHTML = weatherInfo;
        showClothingRecommendations(data.current);
        generateBagItems();
      } catch (error) {
        showMessage('שגיאה בקבלת נתוני מזג אוויר', 'error');
        console.error("Error fetching weather:", error);
      }
    }
    function showClothingRecommendations(weather) {
      const recommendations = [];
      if (weather.temp_c < 15) recommendations.push('מעיל');
      if (weather.temp_c > 25) recommendations.push('בגדים קצרים');
      if (weather.precip_mm > 0) recommendations.push('מטריה');
      if (weather.cloud > 50) recommendations.push('סוודר');
      if (weather.condition.text.includes('שמש')) recommendations.push('כובע ומשקפי שמש');
      const html = `
        <strong>המלצות לבוש:</strong>
        <ul>${recommendations.map(item => `<li>${item}</li>`).join('')}</ul>
      `;
      document.getElementById('clothing-recommendations').innerHTML = html;
    }
    function generateBagItems() {
      if (!currentUser || !users[currentUser].schedule) return;
      const itemsByDay = users[currentUser].schedule.map((subjects, index) => {
        const day = daysOfWeek[index];
        const items = [];
        if (subjects.length > 0) items.push('מחברת', 'עטים');
        if (subjects.some(s => s.includes('מתמטיקה'))) items.push('מחשבון');
        if (subjects.some(s => s.includes('ספורט'))) items.push('בגד ספורט');
        return `
          <div class="day-bag-items">
            <strong>${day}:</strong> ${items.join(', ')}
          </div>
        `;
      }).join('');
      document.getElementById('daily-bag-items').innerHTML = itemsByDay;
    }
    function updateStorage() {
      localStorage.setItem('schoolUsers', JSON.stringify(users));
    }
    function bindSubjectEvents() {
      const subjectCards = document.querySelectorAll('.subject-card');
      Array.from(subjectCards).forEach(card => {
        card.setAttribute('draggable', true);
        card.addEventListener('dragstart', handleDragStart, false);
        card.addEventListener('dragover', handleDragOver, false);
        card.addEventListener('drop', handleDrop, false);
      });
    }
    // Renders the schedule UI, including "Mark Done" buttons for progress tracking.
    function renderScheduleUI() {
      const daysContainer = document.getElementById('days-container');
      daysContainer.innerHTML = '';
      if(!users[currentUser] || !users[currentUser].schedule) return;
      users[currentUser].schedule.forEach((subjects, index) => {
        let subjectHTML = subjects.map((subject, i) => `
          <div class="subject-card" data-index="${i}">
            <span onclick="toggleCompleted(this)">${subject}</span>
            <span class="remove-btn" title="Remove" onclick="removeSubject(${index}, '${subject}')">X</span>
            <button onclick="editSubject(${index}, '${subject}')" title="${translations[currentLang].edit}">${translations[currentLang].edit}</button>
            <button onclick="addNote(${index}, '${subject}')" title="${translations[currentLang].addNote}">${translations[currentLang].addNote}</button>
            <button onclick="setReminder(${index}, '${subject}')" title="${translations[currentLang].reminder}">${translations[currentLang].reminder}</button>
            <button onclick="markDone(this)" title="Mark as Completed">✔️</button>
          </div>
        `).join('');
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-container';
        dayDiv.innerHTML = `
          <h3>${daysOfWeek[index]}</h3>
          <input type="text" id="subject-input-${index}" placeholder="${translations[currentLang].addSubject}">
          <button onclick="addSubject(${index})" title="${translations[currentLang].addSubject}">${translations[currentLang].addSubject}</button>
          <button onclick="sortSubjects(${index})" title="${translations[currentLang].sortSubjects}">${translations[currentLang].sortSubjects}</button>
          <button onclick="clearDay(${index})" title="${translations[currentLang].clearDay}">${translations[currentLang].clearDay}</button>
          <div id="subjects-${index}">
            ${subjectHTML}
          </div>
        `;
        daysContainer.appendChild(dayDiv);
      });
      bindSubjectEvents();
      updateProgress();
    }
    function addSubject(dayIndex) {
      const input = document.getElementById(`subject-input-${dayIndex}`);
      const subject = input.value.trim();
      if (!subject) {
        showMessage('אנא הזן נושא', 'error');
        return;
      }
      if (!users[currentUser].schedule) {
        users[currentUser].schedule = Array.from({length: 6}, () => []);
      }
      users[currentUser].schedule[dayIndex].push(subject);
      updateStorage();
      renderScheduleUI();
      input.value = '';
      generateBagItems();
    }
    function removeSubject(dayIndex, subject) {
      users[currentUser].schedule[dayIndex] =
        users[currentUser].schedule[dayIndex].filter(s => s !== subject);
      updateStorage();
      renderScheduleUI();
      generateBagItems();
    }
    function editSubject(dayIndex, subject) {
      document.getElementById('subject-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('edit-subject-input').value = subject;
      document.getElementById('edit-time-input').value = '08:00-09:00';
      document.getElementById('edit-category-input').value = 'כללי';
    }
    function saveEditedSubject() {
      document.getElementById('subject-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
      showMessage('הנושא עודכן בהצלחה', 'success');
      // (Optional: update the schedule accordingly)
    }
    function exportSchedule() {
      const dataStr = JSON.stringify(users[currentUser].schedule);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const exportFileDefaultName = 'schedule.json';
      let linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }
    function exportScheduleCSV() {
      if (!users[currentUser] || !users[currentUser].schedule) return;
      let csvContent = "data:text/csv;charset=utf-8,";
      users[currentUser].schedule.forEach((subjects, index) => {
        csvContent += daysOfWeek[index] + "," + subjects.join(";") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "schedule.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    function importSchedule() {
      let inputElement = document.createElement('input');
      inputElement.type = 'file';
      inputElement.accept = 'application/json';
      inputElement.addEventListener('change', function(event) {
        let file = event.target.files[0];
        let reader = new FileReader();
        reader.onload = function(e) {
          try {
            users[currentUser].schedule = JSON.parse(e.target.result);
            updateStorage();
            renderScheduleUI();
            generateBagItems();
            showMessage('מערכת השעות עודכנה', 'success');
          } catch (error) {
            showMessage('קובץ לא חוקי', 'error');
          }
        };
        reader.readAsText(file);
      });
      inputElement.click();
    }
    function exportToPDF() {
      showMessage('ייצוא ל-PDF בהקדם', 'success');
    }
    function printSchedule() {
      window.print();
    }
    function showMessage(message, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    let dragSrcEl = null;
    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      return false;
    }
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (dragSrcEl !== this) {
        dragSrcEl.innerHTML = this.innerHTML;
        this.innerHTML = e.dataTransfer.getData('text/html');
        updateStorage();
      }
      return false;
    }
    document.getElementById('search-input').addEventListener('input', function() {
      const query = this.value.toLowerCase();
      const dayContainers = document.querySelectorAll('.day-container');
      dayContainers.forEach(container => {
        const subjects = container.querySelectorAll('.subject-card');
        subjects.forEach(card => {
          card.style.display = card.textContent.toLowerCase().includes(query) ? 'flex' : 'none';
        });
      });
    });
    function sortSubjects(dayIndex) {
      users[currentUser].schedule[dayIndex].sort();
      updateStorage();
      renderScheduleUI();
    }
    function addNote(dayIndex, subject) {
      const note = prompt('הזן הערה עבור הנושא:');
      if (note) {
        const newSubject = subject + ' (' + note + ')';
        removeSubject(dayIndex, subject);
        users[currentUser].schedule[dayIndex].push(newSubject);
        updateStorage();
        renderScheduleUI();
      }
    }
    function renderCalendar() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const date = new Date();
      const currentDay = date.getDate();
      for (let i = 1; i <= 31; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.textContent = i;
        dayDiv.style.background = i === currentDay ? 'var(--secondary-color)' : '#fff';
        dayDiv.style.color = i === currentDay ? '#fff' : 'var(--primary-color)';
        dayDiv.addEventListener('click', () => alert('נבחר היום: ' + i));
        calendar.appendChild(dayDiv);
      }
    }
    renderCalendar();
    function setReminder(dayIndex, subject) {
      const reminderTime = prompt('הזן זמן תזכורת (לדוגמה: 07:30):');
      if (reminderTime) {
        // Request notification permission if not granted
        if (Notification.permission !== "granted") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              new Notification('תזכורת', { body: subject + ' - ' + reminderTime });
            }
          });
        } else {
          new Notification('תזכורת', { body: subject + ' - ' + reminderTime });
        }
        showMessage('תזכורת עבור ' + subject + ' הוגדרה לשעה ' + reminderTime, 'success');
      }
    }
    function clearDay(dayIndex) {
      if (confirm('האם למחוק את כל הנושאים של היום?')) {
        users[currentUser].schedule[dayIndex] = [];
        updateStorage();
        renderScheduleUI();
        generateBagItems();
        showMessage('הנושאים נמחקו', 'success');
      }
    }
    function filterByCategory(category) {
      const dayContainers = document.querySelectorAll('.day-container');
      dayContainers.forEach(container => {
        const subjects = container.querySelectorAll('.subject-card');
        subjects.forEach(card => {
          card.style.display = (card.textContent.includes(category) || category === 'all') ? 'flex' : 'none';
        });
      });
    }
    function backupToCloud() {
      showMessage('גיבוי לענן הצליח', 'success');
    }
    function restoreFromCloud() {
      showMessage('שחזור מגיבוי הענן הצליח', 'success');
    }
    function showAuthForm(formType) {
      document.getElementById('login-or-register').style.display = 'none';
      if (formType === 'register') {
        document.getElementById('register-form').style.display = 'block';
      } else {
        document.getElementById('login-form').style.display = 'block';
      }
    }
    function register() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm-password').value;
      if (!username || !password || !confirmPassword) {
        showMessage('כל השדות נדרשים', 'error');
        return;
      }
      if (password !== confirmPassword) {
        showMessage('הסיסמאות אינן תואמות', 'error');
        return;
      }
      if (users[username]) {
        showMessage('שם המשתמש כבר קיים', 'error');
        return;
      }
      users[username] = { password, schedule: Array.from({length: 6}, () => []) };
      updateStorage();
      showMessage('הרשמה הצליחה!', 'success');
      currentUser = username;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      renderScheduleUI();
    }
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        showMessage('כל השדות נדרשים', 'error');
        return;
      }
      if (!users[username] || users[username].password !== password) {
        showMessage('שם משתמש או סיסמה שגויים', 'error');
        return;
      }
      showMessage('התחברות הצליחה!', 'success');
      currentUser = username;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      renderScheduleUI();
      generateBagItems();
    }
    function logout() {
      currentUser = null;
      showMessage('התנתקת מהמערכת', 'success');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('auth-container').style.display = 'block';
    }
    // Dynamic Clock
    function updateClock() {
      const clockDiv = document.getElementById('clock');
      const now = new Date();
      clockDiv.textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    // Mark as Completed feature & update progress
    function markDone(btn) {
      const subjectSpan = btn.parentElement.querySelector('span');
      btn.parentElement.classList.toggle('completed');
      updateProgress();
    }
    function updateProgress() {
      let total = 0, completed = 0;
      const allCards = document.querySelectorAll('.subject-card');
      total = allCards.length;
      allCards.forEach(card => {
        if (card.classList.contains('completed')) completed++;
      });
      const percent = total ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progress-bar').style.width = percent + "%";
    }
    // Speech Recognition for Voice Input (if supported)
    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        showMessage('דיבור לא נתמך בדפדפן זה', 'error');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = currentLang === 'en' ? 'en-US' : (currentLang === 'ru' ? 'ru-RU' : (currentLang === 'ar' ? 'ar-SA' : (currentLang === 'es' ? 'es-ES' : 'he-IL')));
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        // Add subject to first day by default or choose appropriate logic
        if (currentUser && users[currentUser].schedule) {
          users[currentUser].schedule[0].push(transcript);
          updateStorage();
          renderScheduleUI();
          showMessage('נושא נוסף באמצעות קול: ' + transcript, 'success');
        }
      };
      recognition.onerror = function(event) {
        showMessage('שגיאה בהכרה קולית', 'error');
      };
      recognition.start();
    }
    // Auto-login simulation and persistent settings
    document.addEventListener('DOMContentLoaded', () => {
      currentLang = localStorage.getItem('currentLang') || currentLang;
      const savedTheme = localStorage.getItem('currentTheme') || 'light';
      setTheme(savedTheme);
      const savedCustomTheme = localStorage.getItem('currentCustomTheme') || 'light';
      setCustomTheme(savedCustomTheme);
      const savedFont = localStorage.getItem('currentFont') || 'Arial';
      changeFont(savedFont);
      updateLanguage();
      renderScheduleUI();
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser && users[savedUser]) {
        currentUser = savedUser;
        document.getElementById('current-user').textContent = currentUser;
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderScheduleUI();
        generateBagItems();
      }
    });
    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        localStorage.setItem('currentUser', currentUser);
      }
    });
  </script>
</body>
</html>
