<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מערכת ניהול לימודים מתקדמת PRO</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #4CAF50;
      --background-color: #f0f8ff;
      --error-color: #d32f2f;
      --success-color: #388e3c;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --dark-bg: #1e1e1e;
      --dark-text: #f5f5f5;
      --transition-speed: 0.3s;
    }
    /* Global Reset & Typography */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--primary-color);
      line-height: 1.6;
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
      min-height: 100vh;
      direction: rtl;
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    /* Button Styles */
    button {
      background: linear-gradient(45deg, var(--secondary-color), #45a049);
      color: #fff;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 500;
      text-transform: uppercase;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    button:focus {
      outline: 2px solid var(--secondary-color);
    }
    /* Input, Select & Textarea Styles */
    input, select, textarea {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color var(--transition-speed) ease;
      width: 100%;
      margin-bottom: 10px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
    }
    /* Authentication Container */
    .auth-container {
      max-width: 400px;
      margin: 3rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    /* Dashboard Layout */
    .dashboard {
      display: none;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
    }
    .sidebar {
      width: 250px;
      background: rgba(255,255,255,0.95);
      border-right: 1px solid #ddd;
      padding: 20px;
      box-shadow: 2px 0 12px rgba(0,0,0,0.05);
    }
    .sidebar h2 {
      margin-bottom: 20px;
      font-size: 1.4em;
      text-align: center;
    }
    .sidebar button {
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      font-size: 1em;
      border-radius: 25px;
    }
    .main-content {
      flex: 1;
      padding: 30px;
      background: rgba(255,255,255,0.98);
    }
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    header h1 {
      font-size: 1.8em;
    }
    header #clock {
      font-size: 1.2em;
      font-weight: 700;
    }
    header .controls button,
    header .controls select {
      margin-left: 10px;
      padding: 8px 12px;
      font-size: 0.9em;
      border-radius: 25px;
      background: var(--secondary-color);
      color: #fff;
      border: none;
    }
    header .controls button:hover,
    header .controls select:hover {
      background: #45a049;
    }
    header .controls select {
      background: #fff;
      color: var(--primary-color);
      border: 1px solid #ddd;
    }
    /* Card Component */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-3px);
    }
    /* Weather Section */
    .weather-section select {
      width: 100%;
      margin-bottom: 15px;
    }
    /* Schedule & Calendar Styles */
    #progress-container {
      width: 100%;
      background: #ddd;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    #progress-bar {
      height: 20px;
      background: var(--secondary-color);
      width: 0%;
      transition: width 0.5s;
    }
    .calendar-view {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .calendar-view div {
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      border: 1px solid #ddd;
    }
    .calendar-view div:hover {
      background: #e8f5e9;
    }
    /* Day & Subject Cards */
    .day-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .subject-card {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      background: #e8f5e9;
      padding: 8px 15px;
      margin: 8px 0;
      border-radius: 20px;
      cursor: grab;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    .subject-card:hover {
      background: #c8e6c9;
      transform: scale(1.02);
    }
    .subject-card.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .subject-card span,
    .subject-card button {
      margin-right: 5px;
    }
    .remove-btn {
      cursor: pointer;
      color: var(--error-color);
      font-weight: bold;
    }
    /* School Hours System */
    .school-hours {
      margin-top: 20px;
    }
    .school-hours table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    .school-hours th, .school-hours td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    .school-hours th {
      background: var(--secondary-color);
      color: #fff;
    }
    .school-hours td .delete-hour {
      background: transparent;
      border: none;
      color: var(--error-color);
      font-weight: bold;
      cursor: pointer;
    }
    .school-hours .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .school-hours .form-group select,
    .school-hours .form-group input {
      flex: 1;
    }
    /* Export Options */
    .export-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    .export-options button,
    .export-options select {
      padding: 10px;
      border-radius: 25px;
      background: var(--secondary-color);
      color: #fff;
      border: none;
    }
    .export-options button:hover,
    .export-options select:hover {
      background: #45a049;
    }
    .export-options select {
      background: #fff;
      color: var(--primary-color);
      border: 1px solid #ddd;
    }
    /* Modal & Overlay Styles */
    .modal, .settings-modal, .profile-modal, .help-modal, .feedback-modal {
      display: none;
      position: fixed;
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      z-index: 1100;
      max-width: 300px;
      text-align: center;
    }
    .modal, .profile-modal, .help-modal, .feedback-modal {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .settings-modal {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    /* Notifications */
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1200;
    }
    .message.error { background: #ffebee; color: var(--error-color); }
    .message.success { background: #e8f5e9; color: var(--success-color); }
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        display: flex;
        overflow-x: auto;
      }
      .sidebar button {
        flex: 1;
        margin: 5px;
      }
    }
    /* Dark Mode Adjustments */
    body.dark-mode .card,
    body.dark-mode .sidebar,
    body.dark-mode .main-content,
    body.dark-mode .day-container {
      background: rgba(30,30,30,0.9);
      color: var(--dark-text);
    }
    body.dark-mode .subject-card {
      background: #444;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background: #333;
      color: var(--dark-text);
      border: 1px solid #555;
    }
  </style>
</head>
<body>
  <!-- Authentication Container -->
  <div class="auth-container" id="auth-container">
    <h1 id="auth-heading">🎓 מערכת ניהול לימודים מתקדמת PRO</h1>
    <div id="login-or-register">
      <button id="btn-new-registration" onclick="showAuthForm('register')">📝 הרשמה חדשה</button>
      <button id="btn-login" onclick="showAuthForm('login')">🔑 התחברות</button>
    </div>
    <div id="register-form" style="display: none;">
      <h2 id="register-heading">הרשמה</h2>
      <input type="text" id="reg-username" placeholder="שם משתמש" aria-label="Username">
      <input type="password" id="reg-password" placeholder="סיסמה" aria-label="Password">
      <input type="password" id="reg-confirm-password" placeholder="אימות סיסמה" aria-label="Confirm Password">
      <button onclick="register()">הרשמה</button>
    </div>
    <div id="login-form" style="display: none;">
      <h2 id="login-heading">התחברות</h2>
      <input type="text" id="login-username" placeholder="שם משתמש" aria-label="Username">
      <input type="password" id="login-password" placeholder="סיסמה" aria-label="Password">
      <button onclick="login()">התחבר</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <h2 id="current-user"></h2>
      <button onclick="showSection('schedule')"><i class="fas fa-calendar-alt"></i> מערכת שעות</button>
      <button onclick="showSection('grades')"><i class="fas fa-chart-line"></i> ציונים</button>
      <button onclick="showSection('tasks')"><i class="fas fa-tasks"></i> משימות</button>
      <button onclick="showSection('resources')"><i class="fas fa-book-open"></i> משאבים</button>
      <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> מצב לילה</button>
    </nav>
    <!-- Main Content -->
    <div class="main-content">
      <header>
        <div>
          <h1 id="dashboard-greeting">שלום, <span id="dashboard-username"></span>!</h1>
          <div id="clock"></div>
        </div>
        <div class="controls">
          <button id="btn-logout" onclick="logout()">🚪 יציאה</button>
          <button id="btn-dark-mode" onclick="toggleDarkMode()">🌙 מצב לילה</button>
          <select id="language-select" onchange="changeLanguage(this.value)">
            <option value="he">עברית</option>
            <option value="en">English</option>
            <option value="ru">Русский</option>
            <option value="ar">العربية</option>
            <option value="es">Español</option>
          </select>
          <button id="btn-settings" onclick="toggleSettings()">⚙️ הגדרות</button>
          <button id="btn-profile" onclick="toggleProfile()">👤 פרופיל</button>
          <button id="btn-help" onclick="toggleHelp()">❓ עזרה</button>
        </div>
      </header>

      <!-- Content Sections -->
      <!-- Weather Section -->
      <div class="card weather-section" id="weather">
        <h2><i class="fas fa-cloud-sun"></i> מזג אוויר והמלצות לבוש</h2>
        <select id="city-select" onchange="getWeather(this.value)">
          <option value="">בחר עיר</option>
          <option value="Tel Aviv">תל אביב</option>
          <option value="Jerusalem">ירושלים</option>
          <option value="Haifa">חיפה</option>
          <option value="Beer Sheva">באר שבע</option>
          <option value="Eilat">אילת</option>
        </select>
        <div id="weather-info"></div>
        <div class="bag-items" id="clothing-recommendations"></div>
      </div>

      <!-- Schedule Management Section -->
      <div class="card" id="schedule">
        <h2 id="schedule-heading">📅 ניהול מערכת שעות</h2>
        <input type="text" id="search-input" placeholder="חפש נושא..." aria-label="Search Subject">
        <select id="category-filter" onchange="filterByCategory(this.value)">
          <option value="all">הכל</option>
          <option value="מתמטיקה">מתמטיקה</option>
          <option value="מדעים">מדעים</option>
          <option value="היסטוריה">היסטוריה</option>
          <option value="כללי">כללי</option>
        </select>
        <div id="progress-container">
          <div id="progress-bar"></div>
        </div>
        <div id="days-container"></div>
      </div>

      <!-- Calendar View Section -->
      <div class="card" id="calendar-section">
        <h2><i class="fas fa-calendar-days"></i> לוח שנה</h2>
        <div class="calendar-view" id="calendar"></div>
      </div>

      <!-- School Hours System Section -->
      <div class="card school-hours" id="schoolHours">
        <h2>מערכת שעות לימודים</h2>
        <div id="school-hours-table"></div>
        <div class="form-group">
          <select id="school-hours-day">
            <option value="ראשון">ראשון</option>
            <option value="שני">שני</option>
            <option value="שלישי">שלישי</option>
            <option value="רביעי">רביעי</option>
            <option value="חמישי">חמישי</option>
            <option value="שישי">שישי</option>
          </select>
          <select id="school-hours-time">
            <option value="08:00-09:00">08:00-09:00</option>
            <option value="09:00-10:00">09:00-10:00</option>
            <option value="10:00-11:00">10:00-11:00</option>
            <option value="11:00-12:00">11:00-12:00</option>
            <option value="12:00-13:00">12:00-13:00</option>
            <option value="13:00-14:00">13:00-14:00</option>
          </select>
          <input type="text" id="school-hours-subject" placeholder="נושא">
          <button onclick="addSchoolHour()">הוסף שיעור</button>
        </div>
      </div>

      <!-- Export, Data & Feedback Options -->
      <div class="export-options" id="export">
        <button id="btn-export-schedule" onclick="exportSchedule()">📤 ייצוא מערכת שעות</button>
        <button id="btn-export-pdf" onclick="exportToPDF()">📄 ייצוא ל-PDF</button>
        <button id="btn-export-csv" onclick="exportScheduleCSV()">📑 ייצוא כ-CSV</button>
        <button id="btn-import-schedule" onclick="importSchedule()">📥 יבוא מערכת שעות</button>
        <button id="btn-backup-cloud" onclick="backupToCloud()">☁️ גיבוי לענן</button>
        <button id="btn-restore-cloud" onclick="restoreFromCloud()">♻️ שחזור מגיבוי</button>
        <button id="btn-print-schedule" onclick="printSchedule()">🖨️ הדפס מערכת שעות</button>
        <button id="btn-speech" onclick="startSpeechRecognition()">🎤 הוספת קולי</button>
        <button id="btn-reset-data" onclick="resetData()">♻️ אפס נתונים</button>
        <button id="btn-feedback" onclick="toggleFeedback()">💬 משוב</button>
        <select id="theme-select" onchange="setCustomTheme(this.value)">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="blue">Blue</option>
          <option value="green">Green</option>
          <option value="red">Red</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Modals and Overlay -->
  <div class="modal" id="subject-modal">
    <h3>עריכת נושא</h3>
    <input type="text" id="edit-subject-input" placeholder="ערוך נושא">
    <input type="text" id="edit-time-input" placeholder="שעה (לדוגמה: 08:00-09:00)">
    <select id="edit-category-input">
      <option value="כללי">כללי</option>
      <option value="מתמטיקה">מתמטיקה</option>
      <option value="מדעים">מדעים</option>
      <option value="היסטוריה">היסטוריה</option>
    </select>
    <button onclick="saveEditedSubject()">שמור שינויים</button>
  </div>
  <div class="overlay" id="modal-overlay"></div>

  <div class="settings-modal" id="settings-modal">
    <h3>הגדרות מתקדמות</h3>
    <label for="font-select">בחר גופן:</label>
    <select id="font-select" onchange="changeFont(this.value)">
      <option value="Roboto">Roboto</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>
    <button onclick="resetSettings()">אפס הגדרות</button>
    <button onclick="alert('Feature coming soon: Notification Preferences')">העדפות התראות</button>
    <button onclick="alert('Feature coming soon: Auto-Sync Options')">אפשרויות סנכרון אוטומטי</button>
    <button onclick="toggleSettings()">סגור</button>
  </div>

  <div class="profile-modal" id="profile-modal">
    <h3>פרופיל משתמש</h3>
    <label for="profile-username">שם משתמש:</label>
    <input type="text" id="profile-username" disabled>
    <label for="profile-password">סיסמה חדשה:</label>
    <input type="password" id="profile-password">
    <button onclick="updateProfile()">עדכן פרופיל</button>
    <button onclick="toggleProfile()">סגור</button>
  </div>

  <div class="help-modal" id="help-modal">
    <h3>עזרה</h3>
    <p>ברוכים הבאים למערכת ניהול הלימודים. כאן תוכלו:</p>
    <ul>
      <li>להוסיף, לערוך ולסמן נושאים כהושלמו.</li>
      <li>לעקוב אחרי התקדמותכם באמצעות סרגל התקדמות.</li>
      <li>להשתמש בקלט קולי להוספת נושאים.</li>
      <li>לייצא את מערכת השעות כ-JSON, CSV או PDF.</li>
      <li>להתאים אישית את הנושא, הגופן והשפה.</li>
      <li>לנהל את מערכת השעות הלימודית – קבעו שיעורים בזמן מוגדר לכל יום.</li>
    </ul>
    <button onclick="toggleHelp()">סגור</button>
  </div>

  <div class="feedback-modal" id="feedback-modal">
    <h3>משוב</h3>
    <textarea id="feedback-text" placeholder="כתבו כאן את המשוב..."></textarea>
    <button onclick="submitFeedback()">שלח</button>
    <button onclick="toggleFeedback()">סגור</button>
  </div>

  <!-- JavaScript: Combined & Enhanced Functionality -->
  <script>
    "use strict";
    /***************** Global Variables *****************/
    const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי'];
    const timeSlots = ["08:00-09:00","09:00-10:00","10:00-11:00","11:00-12:00","12:00-13:00","13:00-14:00"];
    let currentUser = null;
    let currentLang = localStorage.getItem('currentLang') || 'he';
    const translations = {
      en: {
        authHeading: "🎓 Advanced Study Management System",
        newRegistration: "📝 New Registration",
        login: "🔑 Login",
        registerHeading: "Register",
        loginHeading: "Login",
        usernamePlaceholder: "Username",
        passwordPlaceholder: "Password",
        confirmPasswordPlaceholder: "Confirm Password",
        logout: "🚪 Logout",
        darkMode: "🌙 Dark Mode",
        weatherHeading: "⛅ Weather & Clothing Recommendations",
        bagItemsHeading: "🎒 Daily Bag Items",
        scheduleHeading: "📅 Schedule Management",
        addSubject: "Add Subject",
        sortSubjects: "Sort Subjects",
        clearDay: "Clear Day",
        edit: "Edit",
        addNote: "Add Note",
        reminder: "Reminder",
        exportSchedule: "📤 Export Schedule",
        exportToPDF: "📄 Export to PDF",
        importSchedule: "📥 Import Schedule",
        backupToCloud: "☁️ Backup to Cloud",
        restoreFromCloud: "♻️ Restore from Cloud",
        lightMode: "Light Mode",
        themeDark: "Dark Theme",
        language: "Language",
        searchPlaceholder: "Search subject..."
      },
      he: {
        authHeading: "🎓 מערכת ניהול לימודים מתקדמת",
        newRegistration: "📝 הרשמה חדשה",
        login: "🔑 התחברות",
        registerHeading: "הרשמה",
        loginHeading: "התחברות",
        usernamePlaceholder: "שם משתמש",
        passwordPlaceholder: "סיסמה",
        confirmPasswordPlaceholder: "אימות סיסמה",
        logout: "🚪 יציאה",
        darkMode: "🌙 מצב לילה",
        weatherHeading: "⛅ מזג אוויר והמלצות לבוש",
        bagItemsHeading: "🎒 פריטים יומיים לתיק",
        scheduleHeading: "📅 ניהול מערכת שעות",
        addSubject: "הוסף נושא",
        sortSubjects: "מיין נושאים",
        clearDay: "נקה יום",
        edit: "ערוך",
        addNote: "הוסף הערה",
        reminder: "תזכורת",
        exportSchedule: "📤 ייצוא מערכת שעות",
        exportToPDF: "📄 ייצוא ל-PDF",
        importSchedule: "📥 יבוא מערכת שעות",
        backupToCloud: "☁️ גיבוי לענן",
        restoreFromCloud: "♻️ שחזור מגיבוי",
        lightMode: "מצב בהיר",
        themeDark: "נושא כהה",
        language: "שפה",
        searchPlaceholder: "חפש נושא..."
      },
      ru: { /* Russian translations if needed */ },
      ar: { /* Arabic translations if needed */ },
      es: { /* Spanish translations if needed */ }
    };
    const themes = {
      light: {
        '--background-color': '#f0f8ff',
        '--primary-color': '#2c3e50',
        '--secondary-color': '#4CAF50'
      },
      dark: {
        '--background-color': '#1e1e1e',
        '--primary-color': '#f5f5f5',
        '--secondary-color': '#4CAF50'
      },
      blue: {
        '--background-color': '#e0f7fa',
        '--primary-color': '#01579b',
        '--secondary-color': '#0288d1'
      },
      green: {
        '--background-color': '#e8f5e9',
        '--primary-color': '#1b5e20',
        '--secondary-color': '#43a047'
      },
      red: {
        '--background-color': '#ffebee',
        '--primary-color': '#b71c1c',
        '--secondary-color': '#e53935'
      }
    };
    // For upcoming class notifications: track which slots have been notified
    let notifiedSlots = {};

    /***************** Utility & UI Update Functions *****************/
    function updateLanguage() {
      localStorage.setItem('currentLang', currentLang);
      document.body.dir = (currentLang === 'he' || currentLang === 'ar') ? "rtl" : "ltr";
      document.getElementById('auth-heading').textContent = translations[currentLang].authHeading;
      document.getElementById('btn-new-registration').textContent = translations[currentLang].newRegistration;
      document.getElementById('btn-login').textContent = translations[currentLang].login;
      document.getElementById('register-heading').textContent = translations[currentLang].registerHeading;
      document.getElementById('login-heading').textContent = translations[currentLang].loginHeading;
      document.getElementById('reg-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('reg-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('reg-confirm-password').placeholder = translations[currentLang].confirmPasswordPlaceholder;
      document.getElementById('login-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('login-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('btn-logout').textContent = translations[currentLang].logout;
      document.getElementById('btn-dark-mode').textContent = translations[currentLang].darkMode;
      document.getElementById('schedule-heading').textContent = translations[currentLang].scheduleHeading;
      document.getElementById('search-input').placeholder = translations[currentLang].searchPlaceholder;
      renderScheduleUI();
    }
    function changeLanguage(lang) {
      currentLang = lang;
      updateLanguage();
    }
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
      } else if (theme === 'light') {
        document.body.classList.remove('dark-mode');
      }
      localStorage.setItem('currentTheme', theme);
    }
    function setCustomTheme(themeName) {
      if (themes[themeName]) {
        Object.keys(themes[themeName]).forEach(key => {
          document.documentElement.style.setProperty(key, themes[themeName][key]);
        });
        localStorage.setItem('currentCustomTheme', themeName);
      }
    }
    function changeFont(fontName) {
      document.body.style.fontFamily = fontName + ", sans-serif";
      localStorage.setItem('currentFont', fontName);
    }
    function toggleDarkMode() {
      if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('currentTheme', 'light');
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('currentTheme', 'dark');
      }
    }
    /***************** Section Navigation *****************/
    function showSection(section) {
      if(section === 'schedule') {
        document.getElementById('schedule').scrollIntoView({ behavior: "smooth" });
      } else if(section === 'calendar') {
        document.getElementById('calendar-section').scrollIntoView({ behavior: "smooth" });
      } else if(section === 'schoolHours') {
        document.getElementById('schoolHours').scrollIntoView({ behavior: "smooth" });
      } else {
        alert("Feature coming soon");
      }
    }
    /***************** Notification & Message *****************/
    function showMessage(message, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    /***************** Authentication *****************/
    const users = JSON.parse(localStorage.getItem('schoolUsers') || '{}');
    function showAuthForm(formType) {
      document.getElementById('login-or-register').style.display = 'none';
      if (formType === 'register') {
        document.getElementById('register-form').style.display = 'block';
      } else {
        document.getElementById('login-form').style.display = 'block';
      }
    }
    function register() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm-password').value;
      if (!username || !password || !confirmPassword) {
        showMessage('כל השדות נדרשים', 'error');
        return;
      }
      if (password !== confirmPassword) {
        showMessage('הסיסמאות אינן תואמות', 'error');
        return;
      }
      if (users[username]) {
        showMessage('שם המשתמש כבר קיים', 'error');
        return;
      }
      // Initialize schedule and schoolHours for the new user
      users[username] = {
        password,
        schedule: Array.from({length: 6}, () => []),
        schoolHours: {}
      };
      daysOfWeek.forEach(day => { users[username].schoolHours[day] = []; });
      updateStorage();
      showMessage('הרשמה הצליחה!', 'success');
      currentUser = username;
      document.getElementById('dashboard-username').textContent = currentUser;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'flex';
      renderScheduleUI();
      renderSchoolHours();
    }
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        showMessage('כל השדות נדרשים', 'error');
        return;
      }
      if (!users[username] || users[username].password !== password) {
        showMessage('שם משתמש או סיסמה שגויים', 'error');
        return;
      }
      showMessage('התחברות הצליחה!', 'success');
      currentUser = username;
      document.getElementById('dashboard-username').textContent = currentUser;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'flex';
      renderScheduleUI();
      generateBagItems();
      renderSchoolHours();
    }
    function logout() {
      currentUser = null;
      showMessage('התנתקת מהמערכת', 'success');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('auth-container').style.display = 'block';
    }
    function updateStorage() {
      localStorage.setItem('schoolUsers', JSON.stringify(users));
    }
    /***************** Weather & Bag Items *****************/
    async function getWeather(city) {
      if (!city) return;
      try {
        const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=bfba7f78869e4222b89154845251302&q=${city}&aqi=no`);
        if (!response.ok) throw new Error("API error");
        const data = await response.json();
        const weatherInfo = `
          <p>טמפרטורה: ${data.current.temp_c}°C</p>
          <p>תנאים: ${data.current.condition.text}</p>
        `;
        document.getElementById('weather-info').innerHTML = weatherInfo;
        showClothingRecommendations(data.current);
        generateBagItems();
      } catch (error) {
        showMessage('שגיאה בקבלת נתוני מזג אוויר', 'error');
        console.error("Error fetching weather:", error);
      }
    }
    function showClothingRecommendations(weather) {
      const recommendations = [];
      if (weather.temp_c < 15) recommendations.push('מעיל');
      if (weather.temp_c > 25) recommendations.push('בגדים קצרים');
      if (weather.precip_mm > 0) recommendations.push('מטריה');
      if (weather.cloud > 50) recommendations.push('סוודר');
      if (weather.condition.text.includes('שמש')) recommendations.push('כובע ומשקפי שמש');
      const html = `<strong>המלצות לבוש:</strong>
                    <ul>${recommendations.map(item => `<li>${item}</li>`).join('')}</ul>`;
      document.getElementById('clothing-recommendations').innerHTML = html;
    }
    function generateBagItems() {
      if (!currentUser || !users[currentUser].schedule) return;
      const itemsByDay = users[currentUser].schedule.map((subjects, index) => {
        const day = daysOfWeek[index];
        const items = [];
        if (subjects.length > 0) items.push('מחברת', 'עטים');
        if (subjects.some(s => s.includes('מתמטיקה'))) items.push('מחשבון');
        return `<div class="day-bag-items"><strong>${day}:</strong> ${items.join(', ')}</div>`;
      }).join('');
      // Optionally, display these items in a dedicated section.
    }
    /***************** Schedule Management *****************/
    function renderScheduleUI() {
      const daysContainer = document.getElementById('days-container');
      daysContainer.innerHTML = '';
      if(!users[currentUser] || !users[currentUser].schedule) return;
      users[currentUser].schedule.forEach((subjects, index) => {
        let subjectHTML = subjects.map((subject, i) => `
          <div class="subject-card" data-index="${i}">
            <span onclick="toggleCompleted(this)">${subject}</span>
            <span class="remove-btn" title="Remove" onclick="removeSubject(${index}, '${subject}')">X</span>
            <button onclick="editSubject(${index}, '${subject}')" title="${translations[currentLang].edit}">${translations[currentLang].edit}</button>
            <button onclick="addNote(${index}, '${subject}')" title="${translations[currentLang].addNote}">${translations[currentLang].addNote}</button>
            <button onclick="setReminder(${index}, '${subject}')" title="${translations[currentLang].reminder}">${translations[currentLang].reminder}</button>
            <button onclick="markDone(this)" title="Mark as Completed">✔️</button>
          </div>
        `).join('');
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-container';
        dayDiv.innerHTML = `
          <h3>${daysOfWeek[index]}</h3>
          <input type="text" id="subject-input-${index}" placeholder="${translations[currentLang].addSubject}">
          <button onclick="addSubject(${index})" title="${translations[currentLang].addSubject}">${translations[currentLang].addSubject}</button>
          <button onclick="sortSubjects(${index})" title="${translations[currentLang].sortSubjects}">${translations[currentLang].sortSubjects}</button>
          <button onclick="clearDay(${index})" title="${translations[currentLang].clearDay}">${translations[currentLang].clearDay}</button>
          <div id="subjects-${index}">${subjectHTML}</div>
        `;
        daysContainer.appendChild(dayDiv);
      });
      bindSubjectEvents();
      updateProgress();
    }
    function addSubject(dayIndex) {
      const input = document.getElementById(`subject-input-${dayIndex}`);
      const subject = input.value.trim();
      if (!subject) {
        showMessage('אנא הזן נושא', 'error');
        return;
      }
      if (!users[currentUser].schedule) {
        users[currentUser].schedule = Array.from({length: 6}, () => []);
      }
      users[currentUser].schedule[dayIndex].push(subject);
      updateStorage();
      renderScheduleUI();
      input.value = '';
      generateBagItems();
    }
    function removeSubject(dayIndex, subject) {
      users[currentUser].schedule[dayIndex] =
        users[currentUser].schedule[dayIndex].filter(s => s !== subject);
      updateStorage();
      renderScheduleUI();
      generateBagItems();
    }
    function editSubject(dayIndex, subject) {
      document.getElementById('subject-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('edit-subject-input').value = subject;
      document.getElementById('edit-time-input').value = '08:00-09:00';
      document.getElementById('edit-category-input').value = 'כללי';
    }
    function saveEditedSubject() {
      document.getElementById('subject-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
      showMessage('הנושא עודכן בהצלחה', 'success');
      // (Optional: update the schedule data)
    }
    function sortSubjects(dayIndex) {
      users[currentUser].schedule[dayIndex].sort();
      updateStorage();
      renderScheduleUI();
    }
    function addNote(dayIndex, subject) {
      const note = prompt('הזן הערה עבור הנושא:');
      if (note) {
        removeSubject(dayIndex, subject);
        users[currentUser].schedule[dayIndex].push(subject + ' (' + note + ')');
        updateStorage();
        renderScheduleUI();
      }
    }
    function setReminder(dayIndex, subject) {
      const reminderTime = prompt('הזן זמן תזכורת (לדוגמה: 07:30):');
      if (reminderTime) {
        if (Notification.permission !== "granted") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              new Notification('תזכורת', { body: subject + ' - ' + reminderTime });
            }
          });
        } else {
          new Notification('תזכורת', { body: subject + ' - ' + reminderTime });
        }
        showMessage('תזכורת עבור ' + subject + ' הוגדרה לשעה ' + reminderTime, 'success');
      }
    }
    function clearDay(dayIndex) {
      if (confirm('האם למחוק את כל הנושאים של היום?')) {
        users[currentUser].schedule[dayIndex] = [];
        updateStorage();
        renderScheduleUI();
        generateBagItems();
        showMessage('הנושאים נמחקו', 'success');
      }
    }
    function filterByCategory(category) {
      const dayContainers = document.querySelectorAll('.day-container');
      dayContainers.forEach(container => {
        const subjects = container.querySelectorAll('.subject-card');
        subjects.forEach(card => {
          card.style.display = (card.textContent.includes(category) || category === 'all') ? 'flex' : 'none';
        });
      });
    }
    function bindSubjectEvents() {
      const subjectCards = document.querySelectorAll('.subject-card');
      Array.from(subjectCards).forEach(card => {
        card.setAttribute('draggable', true);
        card.addEventListener('dragstart', handleDragStart, false);
        card.addEventListener('dragover', handleDragOver, false);
        card.addEventListener('drop', handleDrop, false);
      });
    }
    function toggleCompleted(span) {
      span.parentElement.classList.toggle('completed');
      updateProgress();
    }
    function markDone(btn) {
      toggleCompleted(btn.parentElement.querySelector('span'));
    }
    function updateProgress() {
      const allCards = document.querySelectorAll('.subject-card');
      let total = allCards.length;
      let completed = 0;
      allCards.forEach(card => {
        if (card.classList.contains('completed')) completed++;
      });
      const percent = total ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progress-bar').style.width = percent + "%";
    }
    /***************** Drag & Drop Handlers *****************/
    let dragSrcEl = null;
    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      return false;
    }
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (dragSrcEl !== this) {
        dragSrcEl.innerHTML = this.innerHTML;
        this.innerHTML = e.dataTransfer.getData('text/html');
        updateStorage();
      }
      return false;
    }
    /***************** Calendar & Export Functions *****************/
    function renderCalendar() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const date = new Date();
      const currentDay = date.getDate();
      for (let i = 1; i <= 31; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.textContent = i;
        dayDiv.style.background = i === currentDay ? 'var(--secondary-color)' : '#fff';
        dayDiv.style.color = i === currentDay ? '#fff' : 'var(--primary-color)';
        dayDiv.addEventListener('click', () => alert('נבחר היום: ' + i));
        calendar.appendChild(dayDiv);
      }
    }
    renderCalendar();
    function exportSchedule() {
      const dataStr = JSON.stringify(users[currentUser].schedule);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', 'schedule.json');
      linkElement.click();
    }
    function exportScheduleCSV() {
      if (!users[currentUser] || !users[currentUser].schedule) return;
      let csvContent = "data:text/csv;charset=utf-8,";
      users[currentUser].schedule.forEach((subjects, index) => {
        csvContent += daysOfWeek[index] + "," + subjects.join(";") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "schedule.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    function importSchedule() {
      const inputElement = document.createElement('input');
      inputElement.type = 'file';
      inputElement.accept = 'application/json';
      inputElement.addEventListener('change', function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            users[currentUser].schedule = JSON.parse(e.target.result);
            updateStorage();
            renderScheduleUI();
            generateBagItems();
            showMessage('מערכת השעות עודכנה', 'success');
          } catch (error) {
            showMessage('קובץ לא חוקי', 'error');
          }
        };
        reader.readAsText(file);
      });
      inputElement.click();
    }
    function exportToPDF() {
      showMessage('ייצוא ל-PDF בהקדם', 'success');
    }
    function printSchedule() {
      window.print();
    }
    /***************** School Hours System *****************/
    function renderSchoolHours() {
      if (!currentUser || !users[currentUser].schoolHours) return;
      let html = '<table>';
      // Header Row
      html += '<tr><th>שעה</th>';
      daysOfWeek.forEach(day => { html += `<th>${day}</th>`; });
      html += '</tr>';
      // Rows for each time slot
      timeSlots.forEach(slot => {
        html += `<tr><td>${slot}</td>`;
        daysOfWeek.forEach(day => {
          const classes = users[currentUser].schoolHours[day] || [];
          const entry = classes.find(cls => cls.time === slot);
          if (entry) {
            html += `<td>${entry.subject} <button class="delete-hour" onclick="removeSchoolHour('${day}','${slot}')">X</button></td>`;
          } else {
            html += `<td></td>`;
          }
        });
        html += '</tr>';
      });
      html += '</table>';
      document.getElementById('school-hours-table').innerHTML = html;
    }
    function addSchoolHour() {
      const day = document.getElementById('school-hours-day').value;
      const time = document.getElementById('school-hours-time').value;
      const subject = document.getElementById('school-hours-subject').value.trim();
      if (!subject) {
        showMessage('יש להזין נושא', 'error');
        return;
      }
      const daySchedule = users[currentUser].schoolHours[day];
      if (daySchedule.find(cls => cls.time === time)) {
        showMessage('שיעור כבר קיים בשעה זו', 'error');
        return;
      }
      daySchedule.push({ time, subject });
      updateStorage();
      renderSchoolHours();
      document.getElementById('school-hours-subject').value = '';
      showMessage('השיעור נוסף', 'success');
    }
    function removeSchoolHour(day, time) {
      users[currentUser].schoolHours[day] = users[currentUser].schoolHours[day].filter(cls => cls.time !== time);
      updateStorage();
      renderSchoolHours();
      showMessage('השיעור הוסר', 'success');
    }
    /***************** Upcoming Class Notification *****************/
    function checkUpcomingClass() {
      if (!currentUser) return;
      // Determine today's index (assuming Sunday=0 ... Friday=5)
      const today = new Date();
      let dayIndex = today.getDay();
      if(dayIndex === 6) return; // No classes on Saturday
      const todayName = daysOfWeek[dayIndex];
      const currentMinutes = today.getHours() * 60 + today.getMinutes();
      const slots = users[currentUser].schoolHours[todayName] || [];
      slots.forEach(slot => {
        let startTime = slot.time.split('-')[0];
        const [startHour, startMin] = startTime.split(':').map(Number);
        const slotMinutes = startHour * 60 + startMin;
        if (slotMinutes - currentMinutes <= 10 && slotMinutes - currentMinutes > 0) {
          const key = todayName + slot.time;
          if (!notifiedSlots[key]) {
            if (Notification.permission === "granted") {
              new Notification('הודעת שיעור קרוב', { body: `${slot.subject} בשעה ${slot.time}` });
              notifiedSlots[key] = true;
            }
          }
        }
      });
    }
    setInterval(checkUpcomingClass, 60000);
    /***************** Voice Input *****************/
    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        showMessage('דיבור לא נתמך בדפדפן זה', 'error');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = currentLang === 'en' ? 'en-US' : (currentLang === 'ru' ? 'ru-RU' : (currentLang === 'ar' ? 'ar-SA' : (currentLang === 'es' ? 'es-ES' : 'he-IL')));
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        if (currentUser && users[currentUser].schedule) {
          users[currentUser].schedule[0].push(transcript);
          updateStorage();
          renderScheduleUI();
          showMessage('נושא נוסף באמצעות קול: ' + transcript, 'success');
        }
      };
      recognition.onerror = function(event) {
        showMessage('שגיאה בהכרה קולית', 'error');
      };
      recognition.start();
    }
    /***************** Modal Toggles *****************/
    function toggleSettings() {
      const modal = document.getElementById('settings-modal');
      modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }
    function toggleProfile() {
      const modal = document.getElementById('profile-modal');
      modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
      if (currentUser) {
        document.getElementById('profile-username').value = currentUser;
      }
    }
    function toggleHelp() {
      const modal = document.getElementById('help-modal');
      modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }
    function toggleFeedback() {
      const modal = document.getElementById('feedback-modal');
      modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }
    function submitFeedback() {
      const feedback = document.getElementById('feedback-text').value.trim();
      if(feedback) {
        showMessage('תודה על המשוב!', 'success');
        document.getElementById('feedback-text').value = '';
        toggleFeedback();
      } else {
        showMessage('יש להזין משוב', 'error');
      }
    }
    function resetSettings() {
      localStorage.removeItem('currentLang');
      localStorage.removeItem('currentTheme');
      localStorage.removeItem('currentCustomTheme');
      localStorage.removeItem('currentFont');
      currentLang = 'he';
      setTheme('light');
      setCustomTheme('light');
      changeFont('Roboto');
      updateLanguage();
      toggleSettings();
      showMessage('הגדרות אופסו', 'success');
    }
    function resetData() {
      if(confirm("האם לאפס את כל הנתונים?")) {
        localStorage.clear();
        location.reload();
      }
    }
    /***************** Clock *****************/
    function updateClock() {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    /***************** Auto-Login & Persistent Settings *****************/
    document.addEventListener('DOMContentLoaded', () => {
      currentLang = localStorage.getItem('currentLang') || currentLang;
      const savedTheme = localStorage.getItem('currentTheme') || 'light';
      setTheme(savedTheme);
      const savedCustomTheme = localStorage.getItem('currentCustomTheme') || 'light';
      setCustomTheme(savedCustomTheme);
      const savedFont = localStorage.getItem('currentFont') || 'Roboto';
      changeFont(savedFont);
      updateLanguage();
      renderScheduleUI();
      renderCalendar();
      renderSchoolHours();
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser && users[savedUser]) {
        currentUser = savedUser;
        document.getElementById('dashboard-username').textContent = currentUser;
        document.getElementById('current-user').textContent = currentUser;
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        renderScheduleUI();
        generateBagItems();
        renderSchoolHours();
      }
    });
    window.addEventListener('beforeunload', () => {
      if (currentUser) localStorage.setItem('currentUser', currentUser);
    });
    /***************** Service Worker Registration *****************/
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</body>
</html>
